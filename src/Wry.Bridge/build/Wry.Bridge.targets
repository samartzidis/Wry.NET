<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!--
    Wry.Bridge NuGet package build targets.
    Auto-imported when a consumer adds <PackageReference Include="Wry.Bridge" />.

    This file:
    1. Copies the TypeScript bridge runtime to the consumer's frontend project.
    2. Runs the binding generator against the consumer's compiled assembly.
    3. Builds the frontend via npm (auto-detected when frontend\package.json exists).
    4. Copies built frontend assets to the output directory.
    5. Optionally embeds frontend assets as resources for single-file publishing.

    Configurable properties (set in consumer's .csproj before this import):
      $(WryBridgeOutputDir)       - Where to place runtime.ts and generated .ts (default: frontend\src\bindings)
      $(WryBridgeSkipTypescriptRuntimeCopy) - Set to 'true' to skip runtime.ts copy
      $(WryBridgeSkipBindingGeneration) - Set to 'true' to skip binding generation
      $(WryBridgeSkipFrontendBuild) - Set to 'true' to skip npm install/build
      $(WryBridgePackageManager)  - Package manager command          (default: npm)
      $(WryBridgeFrontendProjectDir) - Frontend project directory    (default: frontend)
      $(WryBridgeEmbedFrontend)   - Set to 'true' to embed frontend assets as resources
      $(WryBridgeFrontendDir)     - Directory containing built frontend (default: wwwroot)
  -->

  <PropertyGroup>
    <WryBridgeOutputDir Condition="'$(WryBridgeOutputDir)' == ''">frontend\src\bindings</WryBridgeOutputDir>
    <WryBridgeFrontendDir Condition="'$(WryBridgeFrontendDir)' == ''">wwwroot</WryBridgeFrontendDir>
    <WryBridgePackageManager Condition="'$(WryBridgePackageManager)' == ''">npm</WryBridgePackageManager>
    <WryBridgeFrontendProjectDir Condition="'$(WryBridgeFrontendProjectDir)' == ''">frontend</WryBridgeFrontendProjectDir>
    <_WryBridgePkgDir>$(MSBuildThisFileDirectory)..\</_WryBridgePkgDir>
  </PropertyGroup>

  <!-- Copy runtime.ts to the bindings output dir (only if it doesn't exist yet) -->
  <Target Name="WryBridgeCopyRuntime"
          BeforeTargets="BeforeBuild"
          Condition="'$(WryBridgeSkipTypescriptRuntimeCopy)' != 'true' AND !Exists('$(WryBridgeOutputDir)\runtime.ts')">
    <MakeDir Directories="$(WryBridgeOutputDir)" />
    <Copy SourceFiles="$(_WryBridgePkgDir)content\bridge\runtime.ts"
          DestinationFolder="$(WryBridgeOutputDir)"
          SkipUnchangedFiles="true" />
    <Message Importance="high" Text="[Wry.Bridge] Copied bridge runtime to $(WryBridgeOutputDir)\runtime.ts" />
  </Target>

  <!-- Run the binding generator after build -->
  <Target Name="WryBridgeGenerateBindings"
          AfterTargets="Build"
          Condition="'$(WryBridgeSkipBindingGeneration)' != 'true'">
    <Exec Command="dotnet &quot;$(_WryBridgePkgDir)tools\net8.0\Wry.Bridge.Generator.dll&quot; &quot;$(TargetPath)&quot; &quot;$(WryBridgeOutputDir)&quot;" />
    <Message Importance="high" Text="[Wry.Bridge] Generated TypeScript bindings in $(WryBridgeOutputDir)" />
  </Target>

  <!--
    Build the frontend project via npm (or configured package manager).
    Auto-detected: only runs when frontend\package.json exists.
    Skip by setting WryBridgeSkipFrontendBuild=true.
    Override the package manager with WryBridgePackageManager (default: npm).
  -->
  <Target Name="WryBridgeBuildFrontend"
          AfterTargets="WryBridgeGenerateBindings"
          Condition="'$(WryBridgeSkipFrontendBuild)' != 'true' AND Exists('$(WryBridgeFrontendProjectDir)\package.json')">
    <Exec Command="$(WryBridgePackageManager) install" WorkingDirectory="$(WryBridgeFrontendProjectDir)" />
    <Exec Command="$(WryBridgePackageManager) run build" WorkingDirectory="$(WryBridgeFrontendProjectDir)" />
    <Message Importance="high" Text="[Wry.Bridge] Built frontend in $(WryBridgeFrontendProjectDir)/" />
  </Target>

  <!--
    Copy built frontend assets to the build output directory.
    Runs after the frontend build, skipped when embedding (assets go into the assembly instead).
  -->
  <Target Name="WryBridgeCopyFrontendOutput"
          AfterTargets="WryBridgeBuildFrontend"
          Condition="'$(WryBridgeEmbedFrontend)' != 'true' AND Exists('$(WryBridgeFrontendDir)')">
    <ItemGroup>
      <_WryBridgeFrontendFiles Include="$(WryBridgeFrontendDir)\**\*" />
    </ItemGroup>
    <Copy SourceFiles="@(_WryBridgeFrontendFiles)"
          DestinationFolder="$(OutDir)$(WryBridgeFrontendDir)\%(RecursiveDir)"
          SkipUnchangedFiles="true" />
    <Message Importance="high" Text="[Wry.Bridge] Copied frontend assets to $(OutDir)$(WryBridgeFrontendDir)/" />
  </Target>

  <!--
    Embed frontend assets as .NET resources for single-file publishing.
    Opt in by setting WryBridgeEmbedFrontend=true (e.g. via dotnet publish -p:...).
    The frontend directory (default: wwwroot/) must already exist from a prior build.
    Resources are given LogicalNames with a "frontend/" prefix so that
    EmbeddedAssetServer can discover and serve them at runtime.
  -->
  <ItemGroup Condition="'$(WryBridgeEmbedFrontend)' == 'true'">
    <EmbeddedResource Include="$(WryBridgeFrontendDir)\**">
      <LogicalName>frontend/%(RecursiveDir)%(Filename)%(Extension)</LogicalName>
    </EmbeddedResource>
  </ItemGroup>

</Project>
